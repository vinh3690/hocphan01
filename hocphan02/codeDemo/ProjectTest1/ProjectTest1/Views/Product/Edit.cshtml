@model ProjectTest1.ViewModels.ProductViewModel
<div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form id="editProductForm" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductModalLabel">✏️ Sửa sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="Id" value="@Model.Id" />
                    
                    <div class="row">
                        <!-- Tên sản phẩm -->
                        <div class="col-md-6 mb-3">
                            <label for="Edit_Name" class="form-label">Tên sản phẩm</label>
                            <input type="text" name="Name" id="Edit_Name" class="form-control" required value="@Model.Name">
                        </div>

                       
                    </div>

                    <!-- Dropdown -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="CategoryLevel1" class="form-label">Danh mục cấp 1</label>
                            <select id="CategoryLevel1" class="form-control" required>
                                <option value="">-- Chọn cấp 1 --</option>
                                @foreach (var item in Model.CategoriesLevel1)
                                {
                                    if (item.Value == Model.SelectedCategoryLevel1Id)
                                    {
                                        <option value="@item.Value" selected="selected">@item.Text</option>
                                    }
                                    else
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="CategoryLevel2" class="form-label">Danh mục cấp 2</label>
                            <select id="CategoryLevel2" class="form-control" required @(Model.CategoriesLevel2?.Any() != true ? "disabled" : null)>
                                <option value="">-- Chọn cấp 2 --</option>
                                @if (Model.CategoriesLevel2 != null)
                                {
                                    foreach (var item in Model.CategoriesLevel2)
                                    {
                                        if (item.Value == Model.SelectedCategoryLevel2Id)
                                        {
                                            <option value="@item.Value" selected="selected">@item.Text</option>
                                        }
                                        else
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="CategoryLevel3" class="form-label">Danh mục cấp 3</label>
                            <select id="CategoryLevel3" name="CategoryId" class="form-control" required @(Model.CategoriesLevel3?.Any() != true ? "disabled" : null)>
                                <option value="">-- Chọn cấp 3 --</option>
                                @if (Model.CategoriesLevel3 != null)
                                {
                                    foreach (var item in Model.CategoriesLevel3)
                                    {
                                        if (item.Value == Model.SelectedCategoryLevel3Id)
                                        {
                                            <option value="@item.Value" selected="selected">@item.Text</option>
                                        }
                                        else
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    }
                                }
                            </select>
                        </div>

                        
                    </div>



                    <!-- Giá + Trạng thái -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="Edit_Price" class="form-label">Giá (VNĐ)</label>
                            <input type="number" name="Price" id="Edit_Price" class="form-control" step="0.01" min="0" required value="@Model.Price">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="Edit_IsActive" class="form-label">Trạng thái</label>
                            <select name="IsActive" id="Edit_IsActive" class="form-control">
                                @if (Model.IsActive)
                                {
                                    <option value="True" selected="selected">Hiển thị</option>
                                    <option value="False">Ẩn</option>
                                }
                                else
                                {
                                    <option value="True">Hiển thị</option>
                                    <option value="False" selected="selected">Ẩn</option>
                                }
                            </select>
                           


                        </div>
                    </div>

                    <!-- Mô tả -->
                    <div class="mb-3">
                        <label for="Edit_Description" class="form-label">Mô tả</label>
                        <textarea name="Description" id="Edit_Description" class="form-control" rows="3" maxlength="200">@Model.Description</textarea>
                    </div>

                    <!-- Ảnh chính -->
                    <div class="mb-3">
                        <label for="Edit_MainImageFile" class="form-label">Ảnh chính</label>
                        <input type="file" name="MainImageFile" id="Edit_MainImageFile" class="form-control" accept="image/*">
                        <div class="mt-2">
                            <img id="Edit_previewMainImage"
                                 src="@(string.IsNullOrEmpty(Model.Img) ? "" : Model.Img)"
                                 alt="Preview"
                                 style="max-width: 200px; display:@(string.IsNullOrEmpty(Model.Img) ? "none" : "block")">

                        </div>
                    </div>

                    <!-- Ảnh phụ -->
                    <div class="mb-3">
                        <label for="Edit_SubImagesFiles" class="form-label">Ảnh phụ (có thể chọn nhiều)</label>
                        <input type="file" name="SubImagesFiles" id="Edit_SubImagesFiles" class="form-control" accept="image/*" multiple>

                        <div class="mt-2 d-flex flex-wrap" id="Edit_previewSubImages">
                            @if (Model.SubImages != null)
                            {
                                foreach (var imgUrl in Model.SubImages)
                                {
                                    <div class="position-relative m-1 existing-image">
                                        <img src="@imgUrl" style="max-width: 100px; height:auto;" />
                                        <button type="button" class="btn-close btn-sm position-absolute top-0 end-0 remove-existing-image"
                                                data-url="@imgUrl" aria-label="Xóa"></button>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                    <!-- Trường ẩn để lưu danh sách URL ảnh phụ cũ -->
                    <input type="hidden" name="ExistingSubImages" id="ExistingSubImages" value="@(Model.SubImages != null ? string.Join(",", Model.SubImages) : "")" />
                    <input type="hidden" name="RemovedImages" id="RemovedImages" />

                    </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Lưu</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/Product.js"></script>
}
<script>
    // Preview ảnh chính edit
    document.getElementById('Edit_MainImageFile').addEventListener('change', function (e) {
        const file = e.target.files[0];
        const preview = document.getElementById('Edit_previewMainImage');
        if (file) {
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
        }
    });

    // Xoá ảnh cũ
       // Xoá ảnh cũ
    $(document).on('click', '.remove-existing-image', function () {
        let imageUrl = $(this).data('url');

        // Cập nhật danh sách ảnh bị xóa
        let removedImages = $('#RemovedImages').val().split(',').filter(Boolean);
        if (!removedImages.includes(imageUrl)) {
            removedImages.push(imageUrl);
        }
        $('#RemovedImages').val(removedImages.join(','));

        // Cập nhật danh sách ảnh cũ còn lại
        let existingImages = $('#ExistingSubImages').val().split(',').filter(Boolean);
        existingImages = existingImages.filter(url => url !== imageUrl);
        $('#ExistingSubImages').val(existingImages.join(','));

        // Xóa phần tử ảnh khỏi UI
        $(this).parent().remove();
    });


    // Hiển thị ảnh mới khi chọn (append, không xóa ảnh cũ)
    $('#Edit_SubImagesFiles').on('change', function () {
        let files = this.files;
        if (files.length > 0) {
            for (let file of files) {
                let reader = new FileReader();
                reader.onload = function (e) {
                    $('#Edit_previewSubImages').append(`
                        <div class="position-relative m-1 new-image">
                            <img src="${e.target.result}" style="max-width: 100px; height:auto;" />
                            <button type="button" class="btn-close btn-sm position-absolute top-0 end-0 remove-new-image" aria-label="Xóa"></button>
                        </div>
                    `);
                }
                reader.readAsDataURL(file);
            }
        }
    });

    // Xoá ảnh mới trước khi submit
    $(document).on('click', '.remove-new-image', function () {
        $(this).parent().remove();
    });
</script>




@model List<ProjectTest1.ViewModels.CartItemViewModel>

@{
    ViewBag.Title = "Giỏ Hàng";
}
<div class="container my-4">
    <!-- container để căn giữa và có padding tự nhiên -->
    <h2 class="mb-4">Giỏ Hàng</h2>

    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
            <tr class="text-center">
                <th>Ảnh</th>
                <th class="text-start">Sản phẩm</th>
                <th>Phân loại</th>
                <th>Giá</th>
                <th>Số lượng</th>
                <th>Thành tiền</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr data-id="@item.ProductVariantId" data-price="@item.UnitPrice">
                    <td style="width:100px;">
                        <img src="@item.ImageUrl" alt="@item.ProductName" class="img-fluid rounded" />
                    </td>
                    <td class="text-start ps-3">@item.ProductName</td>
                    <td class="text-center">SIZE @item.SizeName@if(!string.IsNullOrEmpty(item.ColorName)){
                    <span>, @item.ColorName</span>
                }
</td>
                    <td class="text-center pe-3">
                        @item.UnitPrice.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))
                    </td>
                    <td style="width:130px;" class="text-center">
                        <div class="input-group input-group-sm">
                            <button type="button" class="btn btn-outline-secondary btn-decrease">-</button>
                            <input type="number" class="form-control text-center quantity-input" value="@item.Quantity" min="1">
                            <button type="button" class="btn btn-outline-secondary btn-increase">+</button>
                        </div>
                    </td>
                    <td class="total-price text-center pe-3">
                        @( (item.UnitPrice * item.Quantity).ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN")) )
                    </td>
                    <td class="text-center">
                        <form asp-action="RemoveFromCart" method="post">
                            <input type="hidden" name="ProductId" value="@item.ProductVariantId" />
                            <button type="submit" class="btn btn-sm btn-danger">Xóa</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex mt-4">
        <a href="@Url.Action("Index", "Products")" class="btn btn-secondary me-auto">Tiếp tục mua sắm</a>
        <form asp-action="CreatePaymentUrlVnpay" asp-controller="Payment" method="post" class="ms-auto">
            <input type="hidden" name="Amount" value="@Model.Sum(x => x.Quantity * x.UnitPrice)" />
            <input type="hidden" name="OrderDescription" value="Thanh toán đơn hàng quần áo" />
            <input type="hidden" name="Name" value="@User.Identity.Name" />
            <input type="hidden" name="OrderType" value="other" />

            <button type="submit" class="btn btn-success btn-lg">Thanh toán</button>
        </form>

    </div>
</div>

@section Scripts {
    <script>
        document.querySelectorAll('tr[data-id]').forEach(row => {
            const input = row.querySelector('.quantity-input');
            const totalCell = row.querySelector('.total-price');
            const price = parseFloat(row.dataset.price);

            // tăng
            row.querySelector('.btn-increase').addEventListener('click', () => {
                input.value = parseInt(input.value) + 1;
                totalCell.textContent = (price * input.value).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            });

            // giảm
            row.querySelector('.btn-decrease').addEventListener('click', () => {
                if (parseInt(input.value) > 1) {
                    input.value = parseInt(input.value) - 1;
                    totalCell.textContent = (price * input.value).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                }
            });

            // cập nhật khi gõ trực tiếp
            input.addEventListener('input', () => {
                if (input.value < 1) input.value = 1;
                totalCell.textContent = (price * input.value).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            });
        });
    </script>
}
